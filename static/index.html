<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>EasyTier节点查看</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="../static/img/easytier.png" type="image/x-icon"/>
    <link href="../static/layui/css/layui.css" rel="stylesheet">
</head>

<body>


<!--style="width: 1350px"-->
<div class="layui-form">

    <div class="layui-collapse">


        <div class="layui-colla-item">

            <!--            添加面板的操作-->
            <div class="layui-colla-title">面板操作</div>
            <div class="layui-colla-content layui-show">
                <label class="layui-form-label">自动刷新</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="autoFlush" lay-filter="autoFlush" title="开启|关闭"
                           lay-skin="switch">
                </div>
            </div>


            <!--            添加当前节点信息-->
            <div class="layui-colla-item">
                <div class="layui-colla-title">当前节点信息</div>
                <div class="layui-colla-content layui-show">
                    <div class="layui-row">
                        <div class="layui-col-xs6">
                            <label class="layui-form-label">虚拟IP地址</label>
                            <div class="layui-input-block">
                                <input type="text" name="virtual_ip" id="virtual_ip" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>
                        <div class="layui-col-xs6">
                            <label class="layui-form-label">主机名</label>
                            <div class="layui-input-block">
                                <input type="text" name="hostname" id="hostname" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="layui-col-xs6">
                            <label class="layui-form-label">子网代理</label>
                            <div class="layui-input-block">
                                <input type="text" name="proxy_cidrs" id="proxy_cidrs" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>

                        <div class="layui-col-xs6">
                            <label class="layui-form-label">公网IP</label>
                            <div class="layui-input-block">
                                <input type="text" name="public_ipv4" id="public_ipv4" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="layui-col-xs6">
                            <label class="layui-form-label">Nat类型</label>
                            <div class="layui-input-block">
                                <input type="text" name="udp_stun_type" id="udp_stun_type" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>

                        <div class="layui-col-xs6">
                            <label class="layui-form-label">IPv4地址</label>
                            <div class="layui-input-block">
                                <input type="text" name="interface_ipv4" id="interface_ipv4" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="layui-row">
                        <div class="layui-col-xs6">
                            <label class="layui-form-label">IPv6地址</label>
                            <div class="layui-input-block">
                                <input type="text" name="interface_ipv6" id="interface_ipv6" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>

                        <div class="layui-col-xs6">
                            <label class="layui-form-label">监听地址</label>
                            <div class="layui-input-block">
                                <input type="text" name="listeners" id="listeners" autocomplete="off"
                                       class="layui-input" readonly>
                            </div>
                        </div>
                    </div>

                </div>

            </div>


            <!--        添加一个表格-->
            <div class="layui-colla-item">
                <div class="layui-colla-title">全部节点信息</div>
                <div class="layui-colla-content layui-show">
                    <table class="layui-hide" id="peerList" lay-filter="peerList"></table>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="../static/layui/layui.js"></script>


<script type="text/html" id="peerListToolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="addDevice">新增节点</button>
    </div>
</script>


<script>


    //获取node节点
    function getNode() {

        // 发起 AJAX 请求获取后台数据
        layui.$.ajax({
            url: '../api/node', // 替换为你的后台接口地址
            method: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.code === 0 && response.data) {
                    const data = response.data;

                    // 赋值到表单元素
                    layui.$('#virtual_ip').val(data.virtual_ip);
                    layui.$('#hostname').val(data.hostname);
                    layui.$('#proxy_cidrs').val(data.proxy_cidrs);
                    layui.$('#peer_id').val(data.peer_id);
                    layui.$('#public_ipv4').val(data.public_ipv4);
                    layui.$('#udp_stun_type').val(data.udp_stun_type);
                    layui.$('#interface_ipv4').val(data.interface_ipv4);
                    layui.$('#interface_ipv6').val(data.interface_ipv6);
                    layui.$('#listeners').val(data.listeners);
                    layui.form.render();
                } else {
                    layer.msg('数据加载失败: ' + response.msg, {icon: 2});
                }
            },
            error: function () {
                layer.msg('请求失败，请检查网络或接口', {icon: 2});
            }
        })
    }


    layui.use(['table', 'layer', 'form'], function () {

        const table = layui.table;
        const form = layui.form;

        //调用一下
        getNode();


        // 渲染table 窗口
        table.render({
            elem: '#peerList',
            url: '../api/peer',
            toolbar: '#peerListToolbar',
            defaultToolbar: ['filter', 'exports'],
            title: '全部节点信息',
            even: true,
            skin: 'row',
            cellMinWidth: 80,
            totalRow: false, // 开启合计行
            page: false,
            cols: [[
                {field: 'id', title: '节点ID', align: "center"},
                {field: 'ipv4', title: '虚拟IPv4', sort: true, align: "center"},
                {field: 'hostname', title: '主机名', align: "center"},
                {field: 'cost', title: '穿透方式', align: "center"},
                {field: 'lat_ms', title: '延迟', align: "center"},
                {field: 'loss_rate', title: '丢包率', align: "center"},
                {field: 'rx_bytes', title: '接收', align: "center"},
                {field: 'tx_bytes', title: '发送', align: "center"},
                {field: 'tunnel_proto', title: '协议类型', align: "center"},
                {field: 'nat_type', title: 'Nat类型', align: "center"},
                {field: 'version', title: '内核版本', align: "center"}
            ]],
            done: function () {
            },
            error: function (res, msg) {
                layui.alert("加载数据失败:" + msg)
                console.log(res, msg)
            }
        });


        // 监听工具栏事件
        table.on('toolbar(peerList)', function (obj) {
            switch (obj.event) {
                case 'addDevice':
                    window.open('https://easytier.cn/web/index.html#/config_generator', '_blank');
                    break;
            }
        });


        // 定时刷新 表格的数据
        let refreshTimer = null;
        form.on('switch(autoFlush)', function (obj) {
            const isChecked = obj.elem.checked; // Get the checkbox state (true = checked, false = unchecked)
            console.log('开关触发，状态：' + (isChecked ? '开启' : '关闭')); // 调试日志
            if (isChecked) {
                // Start the timer to refresh the table every 5 seconds
                refreshTimer = setInterval(function () {
                    //刷新当前节点信息
                    getNode();

                    //刷新其他节点信息
                    table.reloadData('peerList', {
                        scrollPos: true,
                        where: {} // Optional: pass additional query parameters if needed
                    });
                    console.log('Peer刷新于 => ' + new Date().toLocaleTimeString());
                }, 5000); // 5000ms = 5 seconds
            } else {
                // Clear the timer when the switch is turned off
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                    refreshTimer = null;
                    console.log('Peer刷新停止');
                }
            }
        });


    });
</script>
</body>

</html>